<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITALL CAMPO - Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>.product-img { object-fit: contain; background: #fff; width: 65px; height: 65px; }</style>
</head>
<body class="bg-gray-100 pb-44 font-sans">

    <header class="bg-blue-900 text-white p-4 sticky top-0 z-50 shadow-lg flex justify-between items-center">
        <div>
            <h1 class="font-bold text-lg italic uppercase tracking-tighter">Itall Campo</h1>
            <p id="contagem-produtos" class="text-[9px] text-blue-300 font-bold uppercase">Sincronizando 373 itens...</p>
        </div>
        <input type="text" id="busca-produto" oninput="render()" placeholder="üîç Buscar na Itall..." class="w-1/2 p-2 rounded-lg text-black text-sm outline-none">
    </header>

    <main class="p-4 max-w-5xl mx-auto space-y-4">
        <section class="bg-white p-4 rounded-2xl shadow-sm border-l-8 border-blue-600">
            <div class="flex gap-2 mb-2">
                <select id="tabela-precos" onchange="mudarTabela()" class="flex-1 border p-3 rounded-xl text-sm bg-gray-50 outline-none font-bold">
                    <option value="">üìä Tabela de Pre√ßos Padr√£o</option>
                </select>
                <select id="forma-pagamento" onchange="mudarFormaPagamento()" class="flex-1 border p-3 rounded-xl text-sm bg-gray-50 outline-none font-bold">
                    <option value="">üí≥ Forma de Pagamento</option>
                </select>
            </div>
            <div class="flex gap-2 mb-2">
                <input type="text" id="cnpj-input" placeholder="CNPJ do Cliente" class="flex-1 border p-3 rounded-xl text-sm bg-gray-50 outline-none">
                <button onclick="buscarCNPJ()" class="bg-blue-600 hover:bg-blue-800 text-white px-6 rounded-xl font-bold text-xs uppercase transition-all">Buscar CNPJ</button>
            </div>
            <div class="relative">
                <input type="text" id="razao-social" placeholder="Raz√£o Social / Nome do Cliente" class="w-full border p-3 rounded-xl text-sm bg-gray-50 font-bold text-blue-900 outline-none" oninput="buscarClientes()">
                <div id="lista-clientes" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-xl mt-1 shadow-lg max-h-48 overflow-y-auto z-10" style="display:none;"></div>
            </div>
        </section>

        <div id="lista-produtos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <div class="text-center p-20 bg-white rounded-3xl border-2 border-dashed col-span-full">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-900 mx-auto mb-4"></div>
                <p class="text-gray-500 font-bold">Acessando estoque da Itall Com√©rcio...</p>
            </div>
        </div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-6 shadow-2xl flex justify-around items-center rounded-t-3xl">
        <div class="text-left">
            <p class="text-[10px] text-gray-400 font-bold uppercase">Total do Pedido</p>
            <p class="text-3xl font-black text-blue-900" id="total-geral">R$ 0,00</p>
        </div>
        <div class="flex gap-2">
            <button onclick="gerarPDF()" class="bg-blue-700 hover:bg-blue-800 text-white px-6 py-4 rounded-2xl font-black text-sm shadow-lg transition-all">
                PDF
            </button>
            <button onclick="enviarWhatsApp()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-2xl font-black text-sm shadow-lg transition-all">
                WHATSAPP
            </button>
        </div>
    </div>

    <script>
        const CONFIG = { key: '4695613971048', secret: 'adcacd22b1c64d9520965dac570b3afd' };
        let produtos = [], estoqueSaldos = {}, carrinho = {};
        let tabelaSelecionada = null;
        let precosTabela = {};
        let formaPagamentoSelecionada = null;
        let debounceTimer = null;

        async function carregarTabelasPrecos() {
            try {
                const res = await fetch("/api/tabelas-precos", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await res.json();
                
                const select = document.getElementById('tabela-precos');
                if (data.tabelas && data.tabelas.length > 0) {
                    data.tabelas.forEach(tabela => {
                        const option = document.createElement('option');
                        option.value = tabela.id;
                        option.textContent = `üìä ${tabela.nome}${tabela.ativa ? '' : ' (inativa)'}`;
                        option.disabled = !tabela.ativa;
                        select.appendChild(option);
                    });
                    console.log(`‚úÖ ${data.tabelas.length} tabelas de pre√ßo carregadas`);
                }
            } catch (e) {
                console.error('Erro ao carregar tabelas:', e);
            }
        }

        async function carregarFormasPagamento() {
            try {
                const res = await fetch("/api/formas-pagamento", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await res.json();
                
                const select = document.getElementById('forma-pagamento');
                if (data.formas && data.formas.length > 0) {
                    data.formas.forEach(forma => {
                        const option = document.createElement('option');
                        option.value = forma.codigo;
                        const parcelas = forma.parcelas > 1 ? ` (${forma.parcelas}x)` : '';
                        option.textContent = `üí≥ ${forma.descricao}${parcelas}`;
                        select.appendChild(option);
                    });
                    console.log(`‚úÖ ${data.formas.length} formas de pagamento carregadas`);
                }
            } catch (e) {
                console.error('Erro ao carregar formas de pagamento:', e);
            }
        }

        function mudarFormaPagamento() {
            const selectElement = document.getElementById('forma-pagamento');
            formaPagamentoSelecionada = selectElement.options[selectElement.selectedIndex].text;
            console.log(`‚úÖ Forma de pagamento selecionada: ${formaPagamentoSelecionada}`);
        }

        async function mudarTabela() {
            const selectElement = document.getElementById('tabela-precos');
            const tabelaId = selectElement.value;
            
            if (!tabelaId) {
                tabelaSelecionada = null;
                precosTabela = {};
                render();
                return;
            }
            
            try {
                const res = await fetch(`/api/tabela-precos/${tabelaId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await res.json();
                
                tabelaSelecionada = selectElement.options[selectElement.selectedIndex].text;
                precosTabela = data.precos || {};
                console.log(`‚úÖ Tabela selecionada: ${tabelaSelecionada}`);
                console.log(`   Pre√ßos carregados: ${Object.keys(precosTabela).length} produtos`);
                render();
            } catch (e) {
                console.error('Erro ao carregar pre√ßos da tabela:', e);
                tabelaSelecionada = null;
                precosTabela = {};
            }
        }

        async function sincronizar() {
            try {
                const resEst = await fetch("/api/estoque", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const dataEst = await resEst.json();
                console.log('Estoque recebido:', dataEst.produtos?.length || 0, 'produtos');
                
                if (dataEst.produtos && dataEst.produtos.length > 0) {
                    produtos = dataEst.produtos.map(p => {
                        const produto = {
                            id: p.cCodigo,
                            nCodProd: p.nCodProd,
                            nome: p.cDescricao,
                            preco: p.nPrecoUnitario || 0,
                            foto: p.url_imagem || null,
                            saldo: p.nSaldo || 0
                        };
                        return produto;
                    });
                    console.log('Primeiro produto com pre√ßo:', produtos[0]);
                    document.getElementById('contagem-produtos').innerText = `${produtos.length} ITENS ATIVOS`;
                    
                    // Carregar tabelas de pre√ßos e formas de pagamento
                    await carregarTabelasPrecos();
                    await carregarFormasPagamento();
                    render();
                } else {
                    throw new Error('Nenhum produto encontrado no estoque');
                }
            } catch (e) {
                console.error('Erro na sincroniza√ß√£o:', e);
                document.getElementById('lista-produtos').innerHTML = `<div class="p-10 text-center font-bold"><p class="text-red-600 mb-4">‚ö†Ô∏è Erro ao sincronizar estoque</p><p class="text-gray-600 text-sm mb-4">${e.message}</p><button onclick="sincronizar()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold">Tentar Novamente</button></div>`;
            }
        }

        function getPrecoAtual(produto) {
            // Se tabela selecionada, usar pre√ßo da tabela
            if (tabelaSelecionada && precosTabela[produto.nCodProd]) {
                return precosTabela[produto.nCodProd];
            }
            // Caso contr√°rio, usar pre√ßo padr√£o
            return produto.preco;
        }

        function render() {
            const termo = document.getElementById('busca-produto').value.toLowerCase();
            const lista = document.getElementById('lista-produtos');
            lista.innerHTML = '';
            
            produtos.filter(p => p.nome.toLowerCase().includes(termo)).forEach(p => {
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-2xl flex gap-3 items-center shadow-sm border border-gray-100';
                const precoAtual = getPrecoAtual(p);
                card.innerHTML = `
                    <div class="flex flex-col items-center gap-1">
                        <img src="${p.foto}" class="product-img rounded border" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-16 h-16 rounded border bg-gray-100 items-center justify-center text-[8px] font-bold text-center p-1 text-gray-500" style="display:none;">SEM FOTO</div>
                        <span class="text-[8px] text-gray-500 font-bold">${p.id}</span>
                    </div>
                    <div class="flex-1 text-left">
                        <h3 class="font-bold text-gray-800 text-[11px] uppercase leading-tight mb-1">${p.nome}</h3>
                        <p class="text-blue-600 font-black text-base">R$ ${precoAtual.toFixed(2).replace('.', ',')}</p>
                        <p class="text-[9px] ${p.saldo > 0 ? 'text-green-600' : 'text-red-500'} font-bold">Estoque: ${p.saldo}</p>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="add('${p.id}', -1)" class="bg-gray-100 text-gray-400 w-7 h-7 rounded-lg font-bold text-sm">‚àí</button>
                        <input type="number" min="0" value="${carrinho[p.id] || 0}" onchange="updateQtd('${p.id}', this.value)" class="font-bold text-blue-900 text-sm w-12 text-center border border-gray-300 rounded px-1">
                        <button onclick="add('${p.id}', 1)" class="bg-blue-900 text-white w-7 h-7 rounded-lg font-bold text-sm shadow-md">+</button>
                    </div>`;
                lista.appendChild(card);
            });
        }
        
        function updateQtd(id, value) {
            const qtd = parseInt(value) || 0;
            if (qtd <= 0) {
                delete carrinho[id];
            } else {
                carrinho[id] = qtd;
            }
            render();
            atualizarTotal();
        }

        function add(id, delta) {
            carrinho[id] = (carrinho[id] || 0) + delta;
            if(carrinho[id] <= 0) delete carrinho[id];
            render();
            atualizarTotal();
        }

        function atualizarTotal() {
            let total = 0;
            Object.keys(carrinho).forEach(id => {
                const p = produtos.find(prod => prod.id == id);
                const precoAtual = getPrecoAtual(p);
                total += precoAtual * carrinho[id];
            });
            document.getElementById('total-geral').innerText = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        async function buscarClientes() {
            const termo = document.getElementById('razao-social').value.trim();
            const listaDiv = document.getElementById('lista-clientes');
            
            // Limpar debounce anterior
            if (debounceTimer) clearTimeout(debounceTimer);
            
            if (termo.length < 2) {
                listaDiv.style.display = 'none';
                return;
            }
            
            // Debounce: esperar 500ms ap√≥s √∫ltimo input antes de buscar
            debounceTimer = setTimeout(async () => {
                try {
                    console.log(`üîç Buscando clientes com termo: "${termo}"`);
                    
                    const res = await fetch("/api/clientes", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ buscar: termo })
                    });
                    
                    if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
                    
                    const data = await res.json();
                    console.log(`  ‚Üí Resposta completa do servidor:`, JSON.stringify(data, null, 2));
                    console.log(`  ‚Üí Total de clientes retornados: ${data.clientes?.length || 0}`);
                    
                    if (data.clientes && data.clientes.length > 0) {
                        // Debug: mostrar nomes dos clientes
                        console.log(`  ‚Üí Primeiros 3 clientes retornados:`, data.clientes.slice(0, 3).map(c => ({
                            razao: c.cRazaoSocial,
                            fantasia: c.cNomeFantasia,
                            cnpj: c.cCNPJ
                        })));
                        
                        listaDiv.innerHTML = '';
                        data.clientes.forEach(cliente => {
                            const div = document.createElement('div');
                            div.className = 'p-3 border-b hover:bg-blue-50 cursor-pointer text-sm transition-colors';
                            const cnpj = cliente.cCNPJ || 'CNPJ n√£o informado';
                            const condicao = cliente.cCondPagtoDesc || 'N√£o informada';
                            div.innerHTML = `
                                <div class="font-bold text-blue-900">${cliente.cRazaoSocial || cliente.cNomeFantasia}</div>
                                <div class="text-gray-600 text-xs">${cnpj}</div>
                                <div class="text-gray-500 text-xs">üìÖ ${condicao}</div>
                            `;
                            div.onclick = () => selecionarCliente(cliente);
                            listaDiv.appendChild(div);
                        });
                        listaDiv.style.display = 'block';
                        console.log(`  ‚úÖ ${data.clientes.length} clientes exibidos`);
                    } else {
                        listaDiv.innerHTML = '<div class="p-3 text-gray-500 text-sm text-center">Nenhum cliente encontrado</div>';
                        listaDiv.style.display = 'block';
                        console.log('  ‚ÑπÔ∏è Nenhum cliente encontrado com esse termo');
                    }
                } catch (e) {
                    console.error('‚ùå Erro ao buscar clientes:', e);
                    listaDiv.innerHTML = '<div class="p-3 text-red-500 text-sm text-center">Erro ao buscar clientes</div>';
                    listaDiv.style.display = 'block';
                }
            }, 500); // Debounce de 500ms
        }

        function selecionarCliente(cliente) {
            document.getElementById('razao-social').value = cliente.cRazaoSocial || cliente.cNomeFantasia;
            document.getElementById('cnpj-input').value = cliente.cCNPJ || '';
            document.getElementById('lista-clientes').style.display = 'none';
            console.log(`‚úÖ Cliente selecionado:`, cliente.cRazaoSocial || cliente.cNomeFantasia);
            
            // Preencher forma de pagamento do cliente
            if (cliente.cCondPagto) {
                const selectFormaPag = document.getElementById('forma-pagamento');
                const options = Array.from(selectFormaPag.options);
                const optionCliente = options.find(opt => opt.textContent.includes(cliente.cCondPagtoDesc));
                if (optionCliente) {
                    selectFormaPag.value = optionCliente.value;
                    mudarFormaPagamento();
                    console.log(`‚úÖ Forma de pagamento do cliente: ${cliente.cCondPagtoDesc}`);
                }
            }
        }
        
        // Fechar lista de clientes ao clicar fora
        document.addEventListener('click', function(event) {
            const listaDiv = document.getElementById('lista-clientes');
            const razaoInput = document.getElementById('razao-social');
            
            if (!listaDiv.contains(event.target) && !razaoInput.contains(event.target)) {
                listaDiv.style.display = 'none';
            }
        });

        async function buscarCNPJ() {
            const cnpj = document.getElementById('cnpj-input').value.replace(/\D/g, ''); // Remove caracteres n√£o-num√©ricos
            
            if (!cnpj || cnpj.length < 11) {
                alert('Por favor, informe um CNPJ v√°lido com 11+ d√≠gitos.');
                return;
            }
            
            try {
                console.log(`üîé Buscando cliente com CNPJ: ${cnpj}`);
                
                const res = await fetch(`/api/cnpj/${cnpj}`);
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                
                const data = await res.json();
                console.log(`  ‚Üí Resposta do servidor:`, data);
                
                if (data.sucesso && data.cliente) {
                    const cliente = data.cliente;
                    const origem = data.origem === 'OMIE' ? '(Cadastrado no OMIE)' : '(Encontrado em registro p√∫blico)';
                    
                    document.getElementById('razao-social').value = cliente.razao_social || cliente.nome_fantasia || '';
                    document.getElementById('cnpj-input').value = cliente.cnpj_cpf || '';
                    
                    // Preencher forma de pagamento se dispon√≠vel
                    if (cliente.recomendacoes?.numero_parcelas) {
                        const selectFormaPag = document.getElementById('forma-pagamento');
                        const parcelas = cliente.recomendacoes.numero_parcelas;
                        const options = Array.from(selectFormaPag.options);
                        const optionCliente = options.find(opt => opt.textContent.includes(parcelas + 'x') || opt.textContent.includes(parcelas));
                        if (optionCliente) {
                            selectFormaPag.value = optionCliente.value;
                            mudarFormaPagamento();
                            console.log(`‚úÖ Forma de pagamento preenchida: ${parcelas}x`);
                        }
                    }
                    
                    console.log(`‚úÖ Cliente carregado com sucesso: ${cliente.razao_social}`);
                    alert(`‚úÖ Cliente encontrado ${origem}\n\n${cliente.razao_social}`);
                } else {
                    console.log('  ‚ÑπÔ∏è Cliente n√£o encontrado com esse CNPJ');
                    alert('‚ùå Cliente n√£o encontrado.\n\nVerifique o CNPJ e tente novamente.');
                    document.getElementById('razao-social').value = '';
                }
            } catch (e) { 
                console.error('‚ùå Erro ao buscar CNPJ:', e);
                alert("‚ùå Erro ao buscar CNPJ.\n\nVerifique se o n√∫mero est√° correto ou tente novamente.");
            }
        }

        function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const cliente = document.getElementById('razao-social').value || "Cliente Itall";
            const tabelaInfo = tabelaSelecionada ? ` - ${tabelaSelecionada}` : '';
            const formaPagInfo = formaPagamentoSelecionada ? ` - ${formaPagamentoSelecionada}` : '';
            
            doc.setFontSize(18);
            doc.setTextColor(30, 58, 138);
            doc.text("ITALL COM√âRCIO - OR√áAMENTO", 14, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Cliente: ${cliente}`, 14, 30);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 35);
            doc.text(`Tabela de Pre√ßos: ${tabelaInfo || 'Padr√£o'}`, 14, 40);
            doc.text(`Forma de Pagamento: ${formaPagInfo || 'N√£o informada'}`, 14, 45);
            
            const rows = Object.keys(carrinho).map(id => {
                const p = produtos.find(prod => prod.id == id);
                const precoAtual = getPrecoAtual(p);
                return [p.nome, carrinho[id], `R$ ${precoAtual.toFixed(2).replace('.', ',')}`, `R$ ${(precoAtual * carrinho[id]).toFixed(2).replace('.', ',')}`];
            });
            
            const totalGeral = document.getElementById('total-geral').innerText;
            doc.autoTable({
                startY: 50,
                head: [['Produto', 'Qtd', 'Unit√°rio', 'Total']],
                body: rows,
                headStyles: { fillColor: [30, 58, 138] },
                foot: [['', '', 'TOTAL GERAL', totalGeral]],
                footStyles: { fillColor: [240, 240, 240], textColor: [30, 58, 138], fontStyle: 'bold' }
            });
            
            doc.save(`Orcamento_Itall_${cliente.split(' ')[0]}.pdf`);
        }

        function enviarWhatsApp() {
            const cliente = document.getElementById('razao-social').value || "Cliente Itall";
            const tabelaInfo = tabelaSelecionada ? ` - ${tabelaSelecionada}` : '';
            const formaPagInfo = formaPagamentoSelecionada ? ` - ${formaPagamentoSelecionada}` : '';
            let msg = `*Or√ßamento Itall Com√©rcio*%0A*Cliente:* ${cliente}%0A*Tabela:* ${tabelaInfo || 'Padr√£o'}%0A*Forma de Pagamento:* ${formaPagInfo || 'N√£o informada'}%0A%0A*Itens:*%0A`;
            Object.keys(carrinho).forEach(id => {
                const p = produtos.find(prod => prod.id == id);
                const precoAtual = getPrecoAtual(p);
                msg += `- ${carrinho[id]}x ${p.nome} (R$ ${precoAtual.toFixed(2).replace('.', ',')})%0A`;
            });
            msg += `%0A*Total Geral:* ${document.getElementById('total-geral').innerText}`;
            window.open(`https://api.whatsapp.com/send?text=${msg}`);
        }

        sincronizar();
    </script>
</body>
</html>
