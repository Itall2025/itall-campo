<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ITALL CAMPO - Força de Vendas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        .fast-tap { touch-action: manipulation; }
        .product-card { transition: transform 0.1s; border: 1px solid #e5e7eb; }
        .product-card:active { transform: scale(0.96); }
    </style>
</head>
<body class="bg-gray-100 pb-44">

    <header class="bg-blue-900 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="flex justify-between items-center mb-3">
            <h1 class="font-bold text-lg tracking-tight">ITALL CAMPO</h1>
            <span class="text-[10px] bg-blue-700 px-2 py-1 rounded">ERP OMIE INTEGRADO</span>
        </div>
        
        <select id="tabela-preco" class="w-full bg-blue-800 p-2 rounded-lg text-sm border-none mb-2 text-white">
            <option value="1">Tabela Padrão (Varejo)</option>
            <option value="2">Tabela Atacado / Revenda</option>
        </select>
        
        <input type="text" id="busca-produto" placeholder="Buscar produto na Itall..." class="w-full p-2 rounded-lg text-black text-sm">
    </header>

    <main class="p-4 space-y-4">
        <section class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-600">
            <div class="flex gap-2 mb-2">
                <input type="number" id="cnpj-input" placeholder="CNPJ para busca..." class="flex-1 border p-2 rounded text-sm">
                <button onclick="buscarCNPJ()" class="bg-blue-600 text-white px-4 rounded font-bold text-xs fast-tap">BUSCAR</button>
            </div>
            <input type="text" id="razao-social" placeholder="Razão Social" class="w-full border p-2 rounded text-sm bg-gray-50" readonly>
        </section>

        <div id="lista-produtos" class="grid grid-cols-1 gap-3">
            <p class="text-center text-gray-500">Carregando estoque da Omie...</p>
        </div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-[0_-5px_15px_rgba(0,0,0,0.1)]">
        <div class="flex justify-between mb-2 font-bold text-blue-900">
            <span>Total com IPI:</span>
            <span id="total-geral">R$ 0,00</span>
        </div>
        <button onclick="gerarOrcamento()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg shadow-md active:bg-green-700 fast-tap">
            GERAR ORÇAMENTO (PDF)
        </button>
    </div>

    <script>
        // --- CONFIGURAÇÃO OMIE - COLOQUE SUAS CHAVES AQUI ---
        const OMIE_CONFIG = {
            app_key: '4695613971048',
            app_secret: 'adcacd22b1c64d9520965dac570b3afd'
        };

        let produtos = [];
        let carrinho = {};

        // 1. CARREGAR PRODUTOS DA OMIE
        async function carregarProdutosOmie() {
            const endpoint = "https://app.omie.com.br/api/v1/geral/produtos/";
            const payload = {
                "call": "ListarProdutos",
                "app_key": OMIE_CONFIG.app_key,
                "app_secret": OMIE_CONFIG.app_secret,
                "param": [{ "pagina": 1, "registros_por_pagina": 50, "filtrar_apenas_omiepdv": "N" }]
            };

            try {
                const response = await fetch(endpoint, { method: 'POST', body: JSON.stringify(payload)});
                const data = await response.json();
                
                produtos = data.produto_servico_resumido.map(p => ({
                    id: p.codigo_produto,
                    nome: p.descricao,
                    preco: p.valor_unitario || 0,
                    estoque: p.quantidade_estoque || 0,
                    ipi: p.aliquota_ipi || 0
                }));
                render();
            } catch (e) {
                console.error(e);
                document.getElementById('lista-produtos').innerHTML = "Erro ao carregar produtos.";
            }
        }

        // 2. BUSCA DE CNPJ (API Pública)
        async function buscarCNPJ() {
            const cnpj = document.getElementById('cnpj-input').value;
            if(cnpj.length < 14) return;
            const res = await fetch(`https://publica.cnpj.ws/cnpj/${cnpj}`);
            const data = await res.json();
            document.getElementById('razao-social').value = data.estabelecimento.razao_social || "Não encontrado";
        }

        // 3. RENDERIZAR TELA
        function render() {
            const lista = document.getElementById('lista-produtos');
            lista.innerHTML = '';
            
            produtos.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card bg-white p-3 rounded-lg flex justify-between items-center';
                card.innerHTML = `
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800 text-sm">${p.nome}</h3>
                        <p class="text-blue-600 font-bold">R$ ${p.preco.toFixed(2)} <span class="text-[10px] text-gray-400">+${p.ipi}% IPI</span></p>
                        <p class="text-[10px] text-gray-500">Estoque: ${p.estoque}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="add('${p.id}', -1)" class="bg-gray-200 w-8 h-8 rounded-full font-bold">-</button>
                        <span id="qtd-${p.id}" class="font-bold">${carrinho[p.id] || 0}</span>
                        <button onclick="add('${p.id}', 1)" class="bg-blue-100 text-blue-700 w-8 h-8 rounded-full font-bold">+</button>
                    </div>
                `;
                lista.appendChild(card);
            });
            atualizarTotal();
        }

        function add(id, delta) {
            carrinho[id] = (carrinho[id] || 0) + delta;
            if(carrinho[id] <= 0) delete carrinho[id];
            render();
        }

        function atualizarTotal() {
            let total = 0;
            Object.keys(carrinho).forEach(id => {
                const p = produtos.find(prod => prod.id == id);
                const precoComIpi = p.preco * (1 + (p.ipi / 100));
                total += precoComIpi * carrinho[id];
            });
            document.getElementById('total-geral').innerText = `R$ ${total.toFixed(2)}`;
        }

        // 4. GERAR PDF E WHATSAPP
        function gerarOrcamento() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const cliente = document.getElementById('razao-social').value || "Cliente Não Identificado";
            
            doc.setFontSize(18);
            doc.text("ORÇAMENTO - ITALL COMÉRCIO", 10, 20);
            doc.setFontSize(12);
            doc.text(`Cliente: ${cliente}`, 10, 30);
            doc.text(`Data: ${new Date().toLocaleDateString()}`, 10, 37);

            const rows = [];
            Object.keys(carrinho).forEach(id => {
                const p = produtos.find(prod => prod.id == id);
                rows.push([p.nome, carrinho[id], `R$ ${p.preco.toFixed(2)}`, `${p.ipi}%`, `R$ ${(p.preco * (1 + p.ipi/100) * carrinho[id]).toFixed(2)}`]);
            });

            doc.autoTable({
                startY: 45,
                head: [['Produto', 'Qtd', 'Unit.', 'IPI', 'Subtotal']],
                body: rows,
            });

            doc.save(`Orcamento_Itall_${cliente}.pdf`);
            alert("PDF Gerado! Agora você pode compartilhar via WhatsApp.");
        }

        carregarProdutosOmie();
    </script>
</body>
</html>
