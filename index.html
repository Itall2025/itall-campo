<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITALL CAMPO - Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>.product-img { object-fit: contain; background: #fff; width: 65px; height: 65px; }</style>
</head>
<body class="bg-gray-100 pb-44 font-sans">

    <header class="bg-blue-900 text-white p-4 sticky top-0 z-50 shadow-lg flex justify-between items-center">
        <div>
            <h1 class="font-bold text-lg italic uppercase tracking-tighter">Itall Campo</h1>
            <p id="contagem-produtos" class="text-[9px] text-blue-300 font-bold uppercase">Sincronizando 373 itens...</p>
        </div>
        <input type="text" id="busca-produto" oninput="render()" placeholder="üîç Buscar na Itall..." class="w-1/2 p-2 rounded-lg text-black text-sm outline-none">
    </header>

    <main class="p-4 max-w-5xl mx-auto space-y-4">
        <section class="bg-white p-4 rounded-2xl shadow-sm border-l-8 border-blue-600">
            <div class="flex gap-2 mb-2">
                <input type="number" id="cnpj-input" placeholder="CNPJ do Cliente" class="flex-1 border p-3 rounded-xl text-sm bg-gray-50 outline-none">
                <button onclick="buscarCNPJ()" class="bg-blue-600 hover:bg-blue-800 text-white px-6 rounded-xl font-bold text-xs uppercase transition-all">Buscar</button>
            </div>
            <input type="text" id="razao-social" placeholder="Raz√£o Social" class="w-full border p-2 rounded-xl text-sm bg-gray-100 font-bold text-blue-900" readonly>
        </section>

        <div id="lista-produtos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <div class="text-center p-20 bg-white rounded-3xl border-2 border-dashed col-span-full">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-900 mx-auto mb-4"></div>
                <p class="text-gray-500 font-bold">Acessando estoque da Itall Com√©rcio...</p>
            </div>
        </div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-6 shadow-2xl flex justify-around items-center rounded-t-3xl">
        <div class="text-left">
            <p class="text-[10px] text-gray-400 font-bold uppercase">Total do Pedido</p>
            <p class="text-3xl font-black text-blue-900" id="total-geral">R$ 0,00</p>
        </div>
        <div class="flex gap-2">
            <button onclick="gerarPDF()" class="bg-blue-700 hover:bg-blue-800 text-white px-6 py-4 rounded-2xl font-black text-sm shadow-lg transition-all">
                PDF
            </button>
            <button onclick="enviarWhatsApp()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-2xl font-black text-sm shadow-lg transition-all">
                WHATSAPP
            </button>
        </div>
    </div>

    <script>
        const CONFIG = { key: '4695613971048', secret: 'adcacd22b1c64d9520965dac570b3afd' };
        let produtos = [], estoqueSaldos = {}, carrinho = {};

        async function sincronizar() {
            try {
                const hoje = new Date().toLocaleDateString('pt-BR');
                
                // Usar modo no-cors ou tentar direto
                const resEst = await fetch("https://app.omie.com.br/api/v1/estoque/consulta/", {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin': '*'
                    },
                    body: JSON.stringify({
                        "call": "ListarPosEstoque",
                        "app_key": CONFIG.key, "app_secret": CONFIG.secret,
                        "param": [{"nPagina": 1, "nRegPorPagina": 500, "dDataPosicao": hoje, "cExibeTodos": "S", "codigo_local_estoque": 0}]
                    })
                }).catch(err => {
                    console.log('Erro estoque direto, tentando alternativa...', err);
                    return null;
                });
                
                if(resEst) {
                    const dataEst = await resEst.json();
                    if(dataEst.produtos) dataEst.produtos.forEach(e => { estoqueSaldos[e.nCodProd] = e.nSaldo; });
                }

                const resProd = await fetch("https://app.omie.com.br/api/v1/geral/produtos/", {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin': '*'
                    },
                    body: JSON.stringify({
                        "call": "ListarProdutos",
                        "app_key": CONFIG.key, "app_secret": CONFIG.secret,
                        "param": [{"pagina": 1, "registros_por_pagina": 500, "inativo": "N"}]
                    })
                }).catch(err => {
                    console.log('Erro produtos direto, tentando alternativa...', err);
                    return null;
                });
                
                if(resProd) {
                    const dataProd = await resProd.json();

                    if (dataProd.produto_servico_cadastro) {
                        produtos = dataProd.produto_servico_cadastro.map(p => ({
                            id: p.codigo_produto,
                            nome: p.descricao,
                            preco: p.valor_unitario || 0,
                            foto: p.imagens?.[0]?.url_imagem || 'https://via.placeholder.com/100?text=ITALL',
                            saldo: estoqueSaldos[p.codigo_produto] || 0
                        }));
                        document.getElementById('contagem-produtos').innerText = `${produtos.length} ITENS ATIVOS`;
                        render();
                    } else {
                        throw new Error('Resposta vazia da API');
                    }
                } else {
                    throw new Error('Falha ao conectar com a API Omie');
                }
            } catch (e) {
                console.error('Erro na sincroniza√ß√£o:', e);
                document.getElementById('lista-produtos').innerHTML = `<div class="p-10 text-center font-bold"><p class="text-red-600 mb-4">‚ö†Ô∏è Erro ao sincronizar estoque</p><p class="text-gray-600 text-sm mb-4">${e.message}</p><button onclick="sincronizar()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold">Tentar Novamente</button></div>`;
            }
        }

        function render() {
            const termo = document.getElementById('busca-produto').value.toLowerCase();
            const lista = document.getElementById('lista-produtos');
            lista.innerHTML = '';
            produtos.filter(p => p.nome.toLowerCase().includes(termo)).forEach(p => {
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-2xl flex gap-3 items-center shadow-sm border border-gray-100';
                card.innerHTML = `<img src="${p.foto}" class="product-img rounded border">
                    <div class="flex-1 text-left"><h3 class="font-bold text-gray-800 text-[10px] uppercase leading-tight">${p.nome}</h3>
                    <p class="text-blue-600 font-black text-sm">R$ ${p.preco.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                    <p class="text-[9px] ${p.saldo > 0 ? 'text-green-600' : 'text-red-500'} font-bold">Estoque: ${p.saldo}</p></div>
                    <div class="flex items-center gap-2">
                        <button onclick="add('${p.id}', -1)" class="bg-gray-100 text-gray-400 w-8 h-8 rounded-lg font-bold">-</button>
                        <span class="font-bold text-blue-900 text-sm w-4 text-center">${carrinho[p.id] || 0}</span>
                        <button onclick="add('${p.id}', 1)" class="bg-blue-900 text-white w-8 h-8 rounded-lg font-bold shadow-md">+</button>
                    </div>`;
                lista.appendChild(card);
            });
        }

        function add(id, delta) {
            carrinho[id] = (carrinho[id] || 0) + delta;
            if(carrinho[id] <= 0) delete carrinho[id];
            render();
            let total = 0;
            Object.keys(carrinho).forEach(id => {
                const p = produtos.find(prod => prod.id == id);
                total += p.preco * carrinho[id];
            });
            document.getElementById('total-geral').innerText = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        async function buscarCNPJ() {
            const cnpj = document.getElementById('cnpj-input').value;
            try {
                const res = await fetch(`https://publica.cnpj.ws/cnpj/${cnpj}`);
                const data = await res.json();
                document.getElementById('razao-social').value = data.estabelecimento?.razao_social || data.razao_social || "N√£o encontrado";
            } catch (e) { 
                console.error('Erro ao buscar CNPJ:', e);
                alert("Erro ao buscar CNPJ. Verifique a conex√£o.");
            }
        }

        function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const cliente = document.getElementById('razao-social').value || "Cliente Itall";
            
            doc.setFontSize(18);
            doc.setTextColor(30, 58, 138);
            doc.text("ITALL COM√âRCIO - OR√áAMENTO", 14, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Cliente: ${cliente}`, 14, 30);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 35);
            
            const rows = Object.keys(carrinho).map(id => {
                const p = produtos.find(prod => prod.id == id);
                return [p.nome, carrinho[id], `R$ ${p.preco.toFixed(2)}`, `R$ ${(p.preco * carrinho[id]).toFixed(2)}`];
            });
            
            doc.autoTable({
                startY: 40,
                head: [['Produto', 'Qtd', 'Unit√°rio', 'Total']],
                body: rows,
                headStyles: { fillColor: [30, 58, 138] },
                foot: [['', '', 'TOTAL GERAL', document.getElementById('total-geral').innerText]],
                footStyles: { fillColor: [240, 240, 240], textColor: [30, 58, 138], fontStyle: 'bold' }
            });
            
            doc.save(`Orcamento_Itall_${cliente.split(' ')[0]}.pdf`);
        }

        function enviarWhatsApp() {
            const cliente = document.getElementById('razao-social').value || "Cliente Itall";
            let msg = `*Or√ßamento Itall Com√©rcio*%0A*Cliente:* ${cliente}%0A%0A*Itens:*%0A`;
            Object.keys(carrinho).forEach(id => {
                const p = produtos.find(prod => prod.id == id);
                msg += `- ${carrinho[id]}x ${p.nome} (R$ ${p.preco.toFixed(2)})%0A`;
            });
            msg += `%0A*Total Geral:* ${document.getElementById('total-geral').innerText}`;
            window.open(`https://api.whatsapp.com/send?text=${msg}`);
        }

        sincronizar();
    </script>
</body>
</html>
